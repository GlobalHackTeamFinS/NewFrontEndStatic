<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Beds Near</title>
    <link href="https://fonts.googleapis.com/css?family=Lato:300,700" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
  </head>
  <body>
    <header>
      <div class="container">
        <div class="row">

          <h1 class="title"><a href="index.html">ONE ROOF</a></h1>

          <div class="your-location">
            <?php

              function distance($lat1, $lon1, $lat2, $lon2, $unit) {

                $theta = $lon1 - $lon2;
                $dist = sin(deg2rad($lat1)) * sin(deg2rad($lat2)) +  cos(deg2rad($lat1)) * cos(deg2rad($lat2)) * cos(deg2rad($theta));
                $dist = acos($dist);
                $dist = rad2deg($dist);
                $miles = $dist * 60 * 1.1515;
                $unit = strtoupper($unit);

                if ($unit == "K") {
                  return ($miles * 1.609344);
                } else if ($unit == "N") {
                    return ($miles * 0.8684);
                  } else {
                      return $miles;
                    }
              }


              if (isset($_GET["street"]) && isset($_GET["city"]) && isset($_GET["state"])){
                $street = $_GET["street"];
                $city = $_GET["city"];
                $state = $_GET["state"];
                echo '<p>'.$street.'</p>';
                echo '<p>'.$city.', '.$state.'</p>';
                // echo '<input type="checkbox" class="input-toggle" id="change-toggle"><label class="change-toggle" for="change-toggle">Change Address</label>';
                echo '<input type="checkbox" class="input-toggle" id="toggle"><label class="change-toggle" for="toggle">Change Address</label>
                      <form class="form-inline input-location change-location" action="index.html">
                        <input type="text" name="street" placeholder="Street Address">
                        <input type="text" name="city" placeholder="City">
                        <input type="text"  name="state" placeholder="State">
                        <button type="submit">SAVE</button>
                      </form>';
               } 
               else {
                echo '<input type="checkbox" class="input-toggle" id="toggle"><label for="toggle">Please Enter An Address</label>
                      <form class="form-inline input-location" action="index.html">
                        <input type="text" name="street" placeholder="Street Address">
                        <input type="text" name="city" placeholder="City">
                        <input type="text"  name="state" placeholder="State">
                        <button type="submit">SAVE</button>
                      </form>';
              }
            ?>
            <!-- <a class="change" href="#">CHANGE</a> -->
          </div>
        </div>
      </div>
    </header>

    <!-- GET LONG AND LAT OF ACURRENT ADDRESS -->

    <?php
      // Get cURL resource
      $curl = curl_init();
      // Set some options - we are passing in a useragent too here
      curl_setopt_array($curl, array(
          CURLOPT_RETURNTRANSFER => 1,
          CURLOPT_URL => 'https://maps.googleapis.com/maps/api/geocode/json?address=20+West+Pine+Street,+Springfield,+IL&key=AIzaSyCF25VMhNe1GmYHpgzxiOFou8DLtMcsxPk',
          CURLOPT_USERAGENT => 'Codular Sample cURL Request'
      ));
      // Send the request & save response to $resp
      $resp = curl_exec($curl);
      // Close request to clear up some resources
      curl_close($curl);

      $respDecoded = json_decode($resp, true);
      $lat = $respDecoded["results"][0]["geometry"]["location"]["lat"];
      $lng = $respDecoded["results"][0]["geometry"]["location"]["lng"];
      // echo $lat.' <br />' .$lng;
    ?>

    <section class="main-container">
      <!-- PARSE JSON -->
      <?php
        $string = file_get_contents("sampleProviders.json");
        $json_a = json_decode($string, true);
        // usort(
        //   $json_a,
        //   function($a, $b) {
        //     if ($a['milesAway'] == $b['milesAway']) {
        //       return 0;
        //     }
        //     return ($a['milesAway'] < $b['milesAway']) ? -1 : 1;
        // });
        // $json = json_encode($json_arr);

        // $json_a = json_decode($json, true);
      ?>

      <!-- START FOR EACH -->

      <?php foreach ($json_a as $users => $user) { ?>
        <div class="list-border">
          <div class="shelter-list-component">
            <div class="container">
              <div class="teaser row">
                <h1 class="title"><?php echo $user['name'] ?></h1>
                  <section>
                    <div class="stats open-beds">
                      <p><?php echo $user['totalBeds'] - $user['occupiedBeds']?></p>
                      <h3>Beds Open</h3>
                    </div>
                    <div class="stats doors-close">
                      <p>
                        <?php
                          $to_time = strtotime("2008-12-13 10:42:00");
                          $from_time = strtotime("2008-12-13 10:21:00");
                          echo round(abs($to_time - $from_time) / 60,2). " min";
                        ?>
                      </p>
                      <h3>Doors Close</h3>
                    </div>
                    <div class="stats miles-away">
                      <p>
                        <?php

                      $shelterLat = $user['gpsLocation']['latitude'];
                      $shelterLng = '-'.$user['gpsLocation']['longitude'];
                      $milesInt = distance($lat, $lng, $shelterLat, $shelterLng, "M");
                      
                      if ($milesInt < 50) {
                        echo number_format((float)$milesInt, 2, '.', '');
                      } else {
                        echo "n/a";
                      }

                      ?>
                    </p>
                    <h3>Miles Away</h3>
                  </div>
                </section>
                <section>
                  <div class="person-icon-container">
                    <?php if ($user['acceptedClients']['men'] === true) { ?>
                      <div class="icon">
                        <img src="/images/male_icon.svg">
                      </div>
                    <?php } ?>
                    <?php if ($user['acceptedClients']['women'] === true) { ?>
                      <div class="icon">
                        <img src="/images/female_icon.svg">
                      </div>
                    <?php } ?>
                    <?php if ($user['acceptedClients']['children'] === true) { ?>
                      <div class="icon">
                        <img src="/images/family.svg">
                      </div>
                    <?php } ?>
                    <?php if ($user['acceptedClients']['veteran'] === true) { ?>
                      <div class="icon">
                        <img src="/images/veterans.svg">
                      </div>
                    <?php } ?>
                    <?php if ($user['acceptedClients']['handicap'] === true) { ?>
                      <div class="icon">
                        <img src="/images/accessible.svg">
                      </div>
                    <?php } ?>
                  </div>
                  <div class="button-container">
                    <button class="shelter-toggle">SHOW MORE</button>
                  </div>
                </section>
              </div>
                <!-- MORE INFO SECTION -->
              <div class="full row more-info clearfix">
                <section class="clearfix">
                  <address>
                    <p class="phone"><?php echo $user['phone'] ?></p>
                    <ul class="address">
                      <li><?php echo $user['address']['line1'] ?></li>
                      <?php
                        $line2 = $user['address']['line2'] ? '<li>' . $user['address']['line2'] . '</li>' : null;
                        echo $line2;
                      ?>
                      <li><?php echo $user['address']['city'] . ', ' . $user['address']['state'] . ' ' .  $user['address']['zip'] ?></li>
                    </ul>
                    <?php 
                      $street = str_replace(" ","+",$user['address']['line1']);
                      $city = str_replace(" ","+",$user['address']['city']);
                      $state = str_replace(" ","+",$user['address']['state']);
                      $zip = str_replace(" ","+",$user['address']['zip']);
                      echo '<a class="get-directions-link" href="https://www.google.com/maps/search/'.$street.'+'.$city.',+'.$state.'+'.$zip.'">Get Directions</a>'
                    ?>
                    
                  </address>
                  <div class="shelter-description">
                    <p><?php echo $user['description'] ?></p>
                  </div>
                </section>

              </div>
            </section>
          </div>
        </div>
      <?php } ?>
      <!-- END FOR EACH -->

    </section>

    <footer>
      <div class="hotline">
        <h3>If you need assistance please call</h3>
        <h2>1-800-555-5555</h2>
      </div>
      <div class="key">
        <h3>Accepted Clients Key:</h3>
        <div class="key-icon">
          <img src="images/accessible.svg">
          <p>Disabled Care</p>
        </div>
        <div class="key-icon">
          <img src="images/family.svg">
          <p>Families</p>
        </div>
        <div class="key-icon">
          <img src="images/female_icon.svg">
          <p>Women</p>
        </div>
        <div class="key-icon">
          <img src="images/male_icon.svg">
          <p>Men</p>
        </div>
        <div class="key-icon">
          <img src="images/veterans.svg">
          <p>Veterans</p>
        </div>
      </div>
    </footer>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="scripts.js"></script>
  </body>
</html>
