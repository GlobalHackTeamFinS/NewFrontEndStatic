<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Beds Near</title>
    <link href="https://fonts.googleapis.com/css?family=Lato:300,700" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
  </head>
  <body>
    <header>
      <div class="container">
        <div class="row">
          <h1 class="title">Beds Nearby</h1>
          <div class="your-location">
            <p>20 West Pine Street</p>
            <p>Springfield, IL 90292</p>
            <a class="change" href="#">CHANGE</a>
          </div>
        </div>
      </div>
    </header>

    <!-- GET LONG AND LAT OF ACURRENT ADDRESS -->
    <?php
      // Get cURL resource
      $curl = curl_init();
      // Set some options - we are passing in a useragent too here
      curl_setopt_array($curl, array(
          CURLOPT_RETURNTRANSFER => 1,
          CURLOPT_URL => 'https://maps.googleapis.com/maps/api/geocode/json?address=20+West+Pine+Street,+Springfield,+IL&key=AIzaSyCF25VMhNe1GmYHpgzxiOFou8DLtMcsxPk',
          CURLOPT_USERAGENT => 'Codular Sample cURL Request'
      ));
      // Send the request & save response to $resp
      $resp = curl_exec($curl);
      // Close request to clear up some resources
      curl_close($curl);

      $respDecoded = json_decode($resp, true);
      $lat = $respDecoded["results"][0]["geometry"]["location"]["lat"];
      $lng = $respDecoded["results"][0]["geometry"]["location"]["lng"];
      
    ?>

    <section class="main-container">
      <!-- PARSE JSON -->
      <?php
        $string = file_get_contents("sampleProviders.json");
        $json_a = json_decode($string, true);
        // usort(
        //   $json_a, 
        //   function($a, $b) { 
        //     if ($a['milesAway'] == $b['milesAway']) {
        //       return 0;
        //     }
        //     return ($a['milesAway'] < $b['milesAway']) ? -1 : 1;
        // });
        // $json = json_encode($json_arr);

        // $json_a = json_decode($json, true);
      ?>

      <!-- START FOR EACH -->
      <div class="container">
      <?php foreach ($json_a as $users => $user) { ?>
          <div class="row">
            <div class="shelter-list-component">
              <h1 class="title"><?php echo $user['name'] ?></h1>
              <section>
                <div class="stats open-beds">
                  <p><?php echo $user['totalBeds'] - $user['occupiedBeds']?></p>
                  <h3>Beds Open</h3>
                </div>
                <div class="stats doors-close">
                  <p>
                    <?php
                      $to_time = strtotime("2008-12-13 10:42:00");
                      $from_time = strtotime("2008-12-13 10:21:00");
                      echo round(abs($to_time - $from_time) / 60,2). " min";
                    ?>
                  </p>
                  <h3>Doors Close</h3>
                </div>
                <div class="stats miles-away">
                  <p>
                    <?php 

                    $shelterLng = $user['gpsLocation']['longitude'];
                    $shelterLat = $user['gpsLocation']['latitude'];
                    

                    // Get cURL resource
                    $curl = curl_init();
                    // Set some options - we are passing in a useragent too here
                    curl_setopt_array($curl, array(
                        CURLOPT_RETURNTRANSFER => 1,
                        CURLOPT_URL => 'https://maps.googleapis.com/maps/api/distancematrix/json?units=imperial&origins='.$lat.','.$lng.'&destinations='.$shelterLng.'%'.$shelterLat.'&key=AIzaSyBa0bYfjOKYOeiK2qnj96bV0_qr1g2uFos',
                        CURLOPT_USERAGENT => 'Codular Sample cURL Request'
                    ));
                    // Send the request & save response to $resp
                    $resp = curl_exec($curl);
                    // Close request to clear up some resources
                    curl_close($curl);

                    $respDecoded = json_decode($resp, true);
                    $miles = $respDecoded['rows'][0]['elements'][0]['distance']['text'];
                    
                    if ($miles != NULL) {
                      echo str_replace("mi","",$miles);
                    } else {
                      echo "N/A";
                    }

                    ?>
                  </p>
                  <h3>Miles Away</h3>
                </div>
              </section>
              <section>
              <div class="person-icon-container">
                <div class="icon">
                  <img src="/images/male_icon.svg">
                </div>
                <div class="icon">
                  <img src="/images/male_icon.svg">
                </div>
                <div class="icon">
                  <img src="/images/male_icon.svg">
                </div>
              </div>
              <div class="button-container">
                <button class="shelter-toggle">SHOW MORE</button>
              </div>
              </section>
              <section class="more-info">
                <div class="container">
                  <div class="row">
                    <address>
                    <p class="phone"><?php echo $user['phone'] ?></p>
                    <ul class="address">
                      <li><?php echo $user['address']['line1'] ?></li>
                      <?php
                        $line2 = $user['address']['line2'] ? '<li>' . $user['address']['line2'] . '</li>' : null;
                        echo $line2;
                      ?>
                      <li><?php echo $user['address']['city'] . ', ' . $user['address']['state'] . ' ' .  $user['address']['zip'] ?></li>
                    </ul>
                    <a href="directions">Get Directions</a>
                    <p>This shelter provides hot showers and breakfast in the morning. Leave time is 6:00 am. Any belongings left in the shelter will be held for one day.</p>
                  </address>
                  </div>
                </div>
              </section>
            </div>
        </div>



      <?php } ?>
      <!-- END FOR EACH -->
    </section>

    <footer>
      <p>If you need assistance please call</p>
      <p>1-800-555-5555</p>
    </footer>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="scripts.js"></script>
  </body>
</html>
